name: Frontend CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Full Stack to Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Navigate to project directory
            cd /opt/url-shortener || exit 1

            # Pull latest code
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            # Update environment variables for production
            echo "âš™ï¸  Updating environment variables..."
            
            # Backend .env
            cd backend
            if [ ! -f .env ]; then
              echo "âŒ Backend .env file not found!"
              exit 1
            fi
            
            # Frontend .env (create if doesn't exist)
            cd ../frontend
            cat > .env.production << EOF
            NEXT_PUBLIC_API_URL=http://${{ secrets.DROPLET_IP }}/api
            NEXT_PUBLIC_BASE_URL=http://${{ secrets.DROPLET_IP }}
            EOF
            
            # Return to root
            cd ..

            # Pull latest Docker images and rebuild
            echo "ðŸ³ Rebuilding Docker images..."
            docker compose pull || true
            docker compose build --no-cache frontend

            # Restart all services
            echo "ðŸ”„ Restarting services..."
            docker compose up -d --remove-orphans

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -af --filter "until=24h"

      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/url-shortener

            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 15

            # Check if containers are running
            echo "ðŸ“Š Checking container status..."
            RUNNING_CONTAINERS=$(docker compose ps --services --filter "status=running" | wc -l)
            TOTAL_CONTAINERS=$(docker compose ps --services | wc -l)

            echo "Running containers: $RUNNING_CONTAINERS/$TOTAL_CONTAINERS"
            docker compose ps

            if [ "$RUNNING_CONTAINERS" -lt "$TOTAL_CONTAINERS" ]; then
              echo "âŒ Deployment failed: Not all containers are running"
              docker compose logs --tail=50
              exit 1
            fi

            # Health check - Backend
            echo "ðŸ¥ Checking backend health..."
            BACKEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")
            if [ "$BACKEND_HEALTH" != "200" ]; then
              echo "âŒ Backend health check failed (HTTP $BACKEND_HEALTH)"
              docker compose logs backend --tail=50
              exit 1
            fi
            echo "âœ… Backend is healthy"

            # Health check - Frontend
            echo "ðŸ¥ Checking frontend health..."
            FRONTEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [ "$FRONTEND_HEALTH" != "200" ]; then
              echo "âŒ Frontend health check failed (HTTP $FRONTEND_HEALTH)"
              docker compose logs frontend --tail=50
              exit 1
            fi
            echo "âœ… Frontend is healthy"

            # Check database connectivity
            echo "ðŸ¥ Checking PostgreSQL..."
            docker compose exec -T postgres pg_isready -U urlshortener || {
              echo "âŒ PostgreSQL health check failed"
              exit 1
            }
            echo "âœ… PostgreSQL is healthy"

            # Check Redis connectivity
            echo "ðŸ¥ Checking Redis..."
            docker compose exec -T redis redis-cli ping | grep -q PONG || {
              echo "âŒ Redis health check failed"
              exit 1
            }
            echo "âœ… Redis is healthy"

            # Check Caddy (reverse proxy)
            echo "ðŸ¥ Checking Caddy reverse proxy..."
            CADDY_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "000")
            if [ "$CADDY_HEALTH" != "200" ]; then
              echo "âš ï¸  Caddy might not be configured yet (HTTP $CADDY_HEALTH)"
            else
              echo "âœ… Caddy is healthy"
            fi

            echo ""
            echo "ðŸŽ‰ Deployment successful! All services are healthy."
            echo ""
            echo "ðŸ“ Access your application:"
            echo "   Frontend: http://${{ secrets.DROPLET_IP }}:3000"
            echo "   Backend:  http://${{ secrets.DROPLET_IP }}:8080"
            echo "   Caddy:    http://${{ secrets.DROPLET_IP }}"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/url-shortener
            echo "âš ï¸  Deployment failed, rolling back..."

            # Get previous commit
            git log -2 --oneline

            # Rollback to previous commit
            git reset --hard HEAD~1

            # Rebuild and restart with old version
            docker compose build
            docker compose up -d

            echo "â†©ï¸  Rolled back to previous version"
            docker compose ps

      - name: Send Deployment Notification
        if: always()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Log deployment status
            if [ "${{ job.status }}" = "success" ]; then
              echo "âœ… Frontend deployment completed successfully at $(date)" >> /var/log/url-shortener-deployments.log
            else
              echo "âŒ Frontend deployment failed at $(date)" >> /var/log/url-shortener-deployments.log
            fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.DROPLET_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŽ¨ Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
            echo "- âš™ï¸  Backend (Go)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ—„ï¸  PostgreSQL" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ Redis" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”€ Caddy Reverse Proxy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
            echo "- Frontend: http://${{ secrets.DROPLET_IP }}:3000" >> $GITHUB_STEP_SUMMARY
            echo "- Backend: http://${{ secrets.DROPLET_IP }}:8080" >> $GITHUB_STEP_SUMMARY
            echo "- Main (via Caddy): http://${{ secrets.DROPLET_IP }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment was rolled back to the previous version." >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

