name: Frontend CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Navigate to repository root
            cd /opt/url-shortener || exit 1

            # Pull latest code
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            # Navigate to frontend directory
            cd frontend

            # Stop existing container
            echo "ðŸ›‘ Stopping existing container..."
            docker stop url-shortener-frontend || true
            docker rm url-shortener-frontend || true

            # Build new image
            echo "ðŸ³ Building frontend Docker image..."
            docker build -t url-shortener-frontend:latest .

            # Run new container
            echo "ðŸ”„ Starting frontend container..."
            docker run -d \
              --name url-shortener-frontend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8080' }} \
              -e NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }} \
              url-shortener-frontend:latest

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -af --filter "until=24h"

      - name: Verify Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Wait for frontend to start
            echo "â³ Waiting for frontend to start..."
            sleep 10

            # Check if frontend container is running
            echo "ðŸ“Š Checking frontend container..."
            if ! docker ps | grep -q "url-shortener-frontend"; then
              echo "âŒ Frontend container is not running"
              docker logs url-shortener-frontend --tail=50
              exit 1
            fi

            # Health check - Frontend
            echo "ðŸ¥ Checking frontend health..."
            FRONTEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
            if [ "$FRONTEND_HEALTH" != "200" ]; then
              echo "âŒ Frontend health check failed (HTTP $FRONTEND_HEALTH)"
              docker logs url-shortener-frontend --tail=50
              exit 1
            fi

            echo ""
            echo "ðŸŽ‰ Frontend deployment successful!"
            echo ""
            echo "ðŸ“ Access your frontend:"
            echo "   Internal: http://localhost:3000"
            echo "   External: http://${{ secrets.DROPLET_IP }}:3000"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER || 'root' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /opt/url-shortener || exit 0
            echo "âš ï¸  Deployment failed, rolling back..."

            # Rollback to previous commit
            git reset --hard HEAD~1

            # Navigate to frontend directory
            cd frontend

            # Stop current container
            docker stop url-shortener-frontend || true
            docker rm url-shortener-frontend || true

            # Rebuild and restart with old version
            docker build -t url-shortener-frontend:latest .
            docker run -d \
              --name url-shortener-frontend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8080' }} \
              -e NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000' }} \
              url-shortener-frontend:latest

            echo "â†©ï¸  Rolled back to previous version"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.DROPLET_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend deployed and running**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Access URLs:**" >> $GITHUB_STEP_SUMMARY
            echo "- Internal: http://localhost:3000" >> $GITHUB_STEP_SUMMARY
            echo "- External: http://${{ secrets.DROPLET_IP }}:3000" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment was rolled back." >> $GITHUB_STEP_SUMMARY
          fi
